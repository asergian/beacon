{% extends "base.html" %}

{% block title %}Inbox - Beacon{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
{% endblock %}

{% block content %}
<!-- Loading Bar -->
<div id="loading-bar" class="loading-bar"></div>
<div id="loading-text" class="loading-text"></div>

<!-- Filters Row -->
<div class="filters-row">
    <div class="filter-group">
        <label for="priority-filter">Priority:</label>
        <select id="priority-filter" onchange="filterEmails()">
            <option value="all">All</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
        </select>
    </div>

    <div class="filter-group">
        <label for="category-filter">Category:</label>
        <select id="category-filter" onchange="filterEmails()">
            <option value="all">All</option>
            <option value="Work">Work</option>
            <option value="Personal">Personal</option>
            <option value="Promotions">Promotions</option>
            <option value="Informational">Informational</option>
        </select>
    </div>

    <div class="filter-group">
        <label for="action-filter">Action:</label>
        <select id="action-filter" onchange="filterEmails()">
            <option value="all">All</option>
            <option value="required">Action Required</option>
            <option value="none">No Action</option>
        </select>
    </div>
</div>

<!-- Updated Content Section -->
<div class="container">
    <!-- Left Column: Email List -->
    <div class="email-list-column">
        <ul class="email-list">
            <!-- Email items will be populated by JavaScript -->
        </ul>
    </div>

    <!-- Right Column: Email Details -->
    <div class="email-details-column">
        <div id="email-details">
            
            
            <div class="email-meta">
                <div class="summary-actions-box">
                    <h2 id="details-subject"></h2>
                    <div class="sender-date">
                        <div class="sender" id="details-sender"></div>
                        <div class="date" id="details-date"></div>
                    </div>
                    
                    <div class="tags-container">
                        <div class="tag" id="details-priority"></div>
                        <div class="tag category" id="details-category"></div>
                        <div class="tag action-required" id="details-action-required"></div>
                        <div id="details-custom-categories"></div>
                    </div>
                    <div class="summary-section">
                        <h3>Summary</h3>
                        <p id="details-summary"></p>
                        <ul id="key-dates-list"></ul>
                    </div>
                </div>
            </div>

            <div id="details-body">
                <div id="email-body" class="email-body-container">
                    <!-- iframe will be inserted here by JavaScript -->
                </div>
            </div>

            <!-- Response Section -->
            <div id="email-response" class="email-response-section">
                <div class="email-compose-header">
                    <h3>Draft a Response</h3>
                    <div class="compose-fields">
                        <div class="compose-field">
                            <label for="response-to">To:</label>
                            <input type="text" id="response-to" readonly>
                        </div>
                        <div class="compose-field">
                            <label for="response-cc">Cc:</label>
                            <input type="text" id="response-cc" placeholder="Add Cc recipients">
                        </div>
                        <div class="compose-field">
                            <label for="response-subject">Subject:</label>
                            <input type="text" id="response-subject">
                        </div>
                    </div>
                </div>
                
                <div class="email-compose-body">
                    <div id="response-editor"></div>
                </div>
                
                <div class="email-compose-actions">
                    <div class="left-actions">
                        <button id="send-button" class="primary-button" onclick="sendEmailResponse()">
                            <span class="button-icon">üì§</span> Send
                        </button>
                        <button id="save-draft-button" class="secondary-button" onclick="saveEmailDraft()">
                            <span class="button-icon">üíæ</span> Save Draft
                        </button>
                    </div>
                    <div class="right-actions">
                        <button id="discard-button" class="danger-button" onclick="discardEmail()">
                            <span class="button-icon">üóëÔ∏è</span> Discard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/email.js') }}"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/classic/ckeditor.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, initializing CKEditor...');
    
    // Create CKEditor instance (completely different API)
    ClassicEditor
        .create(document.querySelector('#response-editor'), {
            toolbar: [
                'undo', 'redo',
                '|', 'heading',
                '|', 'bold', 'italic',
                '|', 'link', 'insertTable',
                '|', 'bulletedList', 'numberedList',
                '|', 'indent', 'outdent',
                '|', 'blockQuote'
            ]
        })
        .then(editor => {
            // Store editor instance for later use
            window.editor = editor;
            
            // Get the editing root and apply custom styles
            const editingRoot = editor.editing.view.document.getRoot();
            
            // Set min-height on the editing root's element
            editor.editing.view.change(writer => {
                writer.setStyle('min-height', '300px', editingRoot);
            });
            
            // Update theme initially
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            updateEditorTheme(isDark);
            
            // Watch for theme changes
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    if (mutation.attributeName === 'data-theme') {
                        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                        updateEditorTheme(isDark);
                    }
                });
            });
            
            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['data-theme']
            });
        })
        .catch(error => {
            console.error('Editor initialization failed:', error);
        });
    
        // Different approach for theme handling in CKEditor 5
        function updateEditorTheme(isDark) {
            const editorElement = document.querySelector('.ck-editor__editable');
            if (editorElement) {
                if (isDark) {
                    editorElement.style.backgroundColor = '#2d2d2d';
                    editorElement.style.color = '#f5f5f5';
                    editorElement.style.borderColor = '#444';
                } else {
                    editorElement.style.backgroundColor = '#ffffff';
                    editorElement.style.color = '#333333';
                    editorElement.style.borderColor = '#c4c4c4';
                }
            }
            
            // Also style the toolbar in dark mode
            const toolbar = document.querySelector('.ck-toolbar');
            if (toolbar && isDark) {
                toolbar.style.backgroundColor = '#333';
                toolbar.style.borderColor = '#444';
            }
        }
    });
</script>
{% endblock %}
