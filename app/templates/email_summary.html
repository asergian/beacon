{% extends "base.html" %}

{% block title %}Inbox - Beacon{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
{% endblock %}

{% block content %}
<!-- Loading Bar -->
<div id="loading-bar" class="loading-bar"></div>
<div id="loading-text" class="loading-text"></div>

<!-- Filters Row -->
<div class="filters-row">
    <div class="filter-group">
        <label for="priority-filter">Priority:</label>
        <select id="priority-filter" onchange="filterEmails()">
            <option value="all">All</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
        </select>
    </div>

    <div class="filter-group">
        <label for="category-filter">Category:</label>
        <select id="category-filter" onchange="filterEmails()">
            <option value="all">All</option>
            <option value="Work">Work</option>
            <option value="Personal">Personal</option>
            <option value="Promotions">Promotions</option>
            <option value="Informational">Informational</option>
        </select>
    </div>

    <div class="filter-group">
        <label for="action-filter">Action:</label>
        <select id="action-filter" onchange="filterEmails()">
            <option value="all">All</option>
            <option value="required">Action Required</option>
            <option value="none">No Action</option>
        </select>
    </div>
</div>

<!-- Updated Content Section -->
<div class="container">
    <!-- Left Column: Email List -->
    <div class="email-list-column">
        <ul class="email-list">
            <!-- Email items will be populated by JavaScript -->
        </ul>
    </div>

    <!-- Right Column: Email Details -->
    <div class="email-details-column">
        <div id="email-details">
            
            
            <div class="email-meta">
                <div class="summary-actions-box">
                    <h2 id="details-subject"></h2>
                    <div class="sender-date">
                        <div class="sender" id="details-sender"></div>
                        <div class="date" id="details-date"></div>
                    </div>
                    
                    <div class="tags-container">
                        <div class="tag" id="details-priority"></div>
                        <div class="tag category" id="details-category"></div>
                        <div class="tag action-required" id="details-action-required"></div>
                    </div>
                    <div class="summary-section">
                        <h3>Summary</h3>
                        <p id="details-summary"></p>
                        <ul id="key-dates-list"></ul>
                    </div>
                </div>
            </div>

            <div id="details-body">
                <div id="email-body" class="email-body-container">
                    <!-- iframe will be inserted here by JavaScript -->
                </div>
            </div>

            <!-- Response Section -->
            <div id="email-response" class="email-response-section">
                <div class="email-compose-header">
                    <h3>Draft a Response</h3>
                    <div class="compose-fields">
                        <div class="compose-field">
                            <label for="response-to">To:</label>
                            <input type="text" id="response-to" readonly>
                        </div>
                        <div class="compose-field">
                            <label for="response-cc">Cc:</label>
                            <input type="text" id="response-cc" placeholder="Add Cc recipients">
                        </div>
                        <div class="compose-field">
                            <label for="response-subject">Subject:</label>
                            <input type="text" id="response-subject">
                        </div>
                    </div>
                </div>
                
                <div class="email-compose-body">
                    <textarea id="response-editor"></textarea>
                </div>
                
                <div class="email-compose-actions">
                    <div class="left-actions">
                        <button id="send-button" class="primary-button" onclick="sendEmailResponse()">
                            <span class="button-icon">üì§</span> Send
                        </button>
                        <button id="save-draft-button" class="secondary-button" onclick="saveEmailDraft()">
                            <span class="button-icon">üíæ</span> Save Draft
                        </button>
                    </div>
                    <div class="right-actions">
                        <button id="discard-button" class="danger-button" onclick="discardEmail()">
                            <span class="button-icon">üóëÔ∏è</span> Discard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/email.js') }}"></script>
<script src="https://cdn.tiny.cloud/1/{{ tiny_mce_api_key }}/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<script>
    // Initialize TinyMCE after DOM loads
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded, initializing TinyMCE...');
        tinymce.init({
            selector: '#response-editor',
            plugins: 'link lists image table code help wordcount emoticons',
            toolbar: 'undo redo | blocks | bold italic underline strikethrough | alignleft aligncenter alignright | bullist numlist | link image emoticons | formatselect',
            menubar: 'file edit view insert format tools',
            height: 300,
            skin: document.documentElement.getAttribute('data-theme') === 'dark' ? 'oxide-dark' : 'oxide',
            content_css: document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default',
            content_style: `
                body {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                    font-size: 14px;
                    background: ${getComputedStyle(document.documentElement).getPropertyValue('--input-bg')};
                    color: ${getComputedStyle(document.documentElement).getPropertyValue('--text-color')};
                }
            `,
            branding: false,
            promotion: false,
            placeholder: 'Write your response here...'
        });

        // Update TinyMCE theme when system theme changes
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    tinymce.activeEditor.setOption('skin', isDark ? 'oxide-dark' : 'oxide');
                    tinymce.activeEditor.setOption('content_css', isDark ? 'dark' : 'default');
                    
                    // Update content area background and text color
                    const contentStyle = `
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                            font-size: 14px;
                            background: ${getComputedStyle(document.documentElement).getPropertyValue('--input-bg')};
                            color: ${getComputedStyle(document.documentElement).getPropertyValue('--text-color')};
                        }
                    `;
                    tinymce.activeEditor.dom.addStyle(contentStyle);
                }
            });
        });

        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['data-theme']
        });
    });
</script>
{% endblock %}
