{% extends "base.html" %}

{% block title %}Analytics Dashboard{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .stats-container {
        padding: 2rem;
        height: calc(100vh - var(--header-height) - var(--footer-height));
        overflow-y: auto;
        background-color: #f4f7f9;
        margin-bottom: 3rem;
    }
    
    .stats-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .stats-header {
        color: #006F6A;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .stats-header h2 {
        margin: 0;
        font-size: 1.5rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .stat-item {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
        transition: transform 0.2s ease;
    }
    
    .stat-item:hover {
        transform: translateY(-2px);
    }
    
    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #006F6A;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.5rem;
    }
    
    .chart-container {
        height: 300px;
        margin-top: 1.5rem;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
    }
    
    .activity-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .activity-item {
        padding: 1rem;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s ease;
    }
    
    .activity-item:hover {
        background-color: #f8f9fa;
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
    
    .activity-time {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    
    .refresh-button {
        background: #006F6A;
        color: white;
        border: none;
        padding: 0.5rem 1.2rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
    }
    
    .refresh-button:hover {
        background: #005753;
        transform: translateY(-1px);
    }
    
    .refresh-button:active {
        transform: translateY(0);
    }
    
    @media (max-width: 768px) {
        .stats-container {
            padding: 1rem;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .chart-container {
            height: 250px;
        }
    }
    
    .error-message {
        background-color: #fff3f3;
        border: 1px solid #dc3545;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: none;
    }
    
    .error-content {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .error-content strong {
        color: #dc3545;
    }
    
    .error-content p {
        margin: 0;
        color: #666;
    }
    
    .error-content .refresh-button {
        align-self: flex-start;
        background-color: #dc3545;
    }
    
    .error-content .refresh-button:hover {
        background-color: #c82333;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-container">
    <div class="stats-card">
        <div class="stats-header">
            <h2>LLM Usage Statistics</h2>
            <button class="refresh-button" onclick="refreshStats()">Refresh</button>
        </div>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="total-tokens">-</div>
                <div class="stat-label">Total Tokens</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-requests">-</div>
                <div class="stat-label">Total Requests</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="success-rate">-</div>
                <div class="stat-label">Success Rate</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-cost">-</div>
                <div class="stat-label">Total Cost ($)</div>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="avg-tokens-per-req">-</div>
                <div class="stat-label">Avg. Tokens/Request</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avg-cost-per-req">-</div>
                <div class="stat-label">Avg. Cost/Request</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="llm-avg-processing-time">-</div>
                <div class="stat-label">Avg. Processing Time (ms)</div>
            </div>
        </div>
        
        <div class="chart-container" id="llm-usage-chart"></div>
        <div class="chart-container" id="llm-model-distribution"></div>
    </div>
    
    <div class="stats-card">
        <h2>Email Processing Statistics</h2>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="total-fetched">-</div>
                <div class="stat-label">Total Fetched</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="cache-hit-rate">-</div>
                <div class="stat-label">Cache Hit Rate</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="analysis-failure-rate">-</div>
                <div class="stat-label">Analysis Failure Rate</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="action-required">-</div>
                <div class="stat-label">Action Required</div>
            </div>
        </div>
        <div class="chart-container" id="email-category-chart"></div>
        <div class="chart-container" id="email-priority-chart"></div>
    </div>
    
    <div class="stats-card">
        <h2>NLP Analytics</h2>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="entities-extracted">-</div>
                <div class="stat-label">Total Entities</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="urgent-emails">-</div>
                <div class="stat-label">Urgent Emails (%)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avg-complexity">-</div>
                <div class="stat-label">Avg. Sentences/Email</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avg-processing-time">-</div>
                <div class="stat-label">Avg. Processing Time (ms)</div>
            </div>
        </div>
        <div class="chart-container" id="nlp-analytics-chart"></div>
    </div>
    
    <div class="stats-card">
        <div class="stats-header">
            <h2>Recent Activity</h2>
            <button class="refresh-button" onclick="debugActivities()">Debug Raw Data</button>
        </div>
        <ul class="activity-list" id="activity-list">
            <!-- Activities will be populated by JavaScript -->
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
let currentStats = null;
let isLoading = false;

async function fetchAnalytics() {
    if (isLoading) return;
    
    try {
        isLoading = true;
        updateLoadingState(true);
        
        const response = await fetch('/user/api/analytics');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        if (data.error) {
            throw new Error(data.error);
        }
        
        currentStats = data;
        updateDashboard(data);
        updateLoadingState(false);
    } catch (error) {
        console.error('Failed to fetch analytics:', error);
        showError(error.message);
        updateLoadingState(false);
    } finally {
        isLoading = false;
    }
}

function updateLoadingState(loading) {
    const button = document.querySelector('.refresh-button');
    if (loading) {
        button.innerHTML = '<span class="loading-spinner"></span> Loading...';
        button.disabled = true;
    } else {
        button.innerHTML = 'Refresh';
        button.disabled = false;
    }
}

function showError(message) {
    // Create error element if it doesn't exist
    let errorEl = document.getElementById('error-message');
    if (!errorEl) {
        errorEl = document.createElement('div');
        errorEl.id = 'error-message';
        errorEl.className = 'error-message';
        document.querySelector('.stats-container').prepend(errorEl);
    }
    
    errorEl.innerHTML = `
        <div class="error-content">
            <strong>Error loading analytics:</strong>
            <p>${message}</p>
            <button onclick="fetchAnalytics()" class="refresh-button">Retry</button>
        </div>
    `;
    errorEl.style.display = 'block';
}

function updateDashboard(data) {
    console.log('Received analytics data:', data);
    
    // Hide any existing error message
    const errorEl = document.getElementById('error-message');
    if (errorEl) {
        errorEl.style.display = 'none';
    }
    
    // Update email stats
    console.log('Updating email stats:', data.email_stats);
    const emailStats = data.email_stats || {};
    
    // Basic stats
    document.getElementById('total-fetched').textContent = 
        (emailStats.total_fetched || 0).toLocaleString();
    
    // Cache hit rate (inverse of new emails rate)
    const totalFetched = emailStats.total_fetched || 0;
    const newEmails = emailStats.new_emails || 0;
    const cacheHitRate = totalFetched > 0 ? 
        ((totalFetched - newEmails) / totalFetched * 100) : 0;
    document.getElementById('cache-hit-rate').textContent = 
        `${cacheHitRate.toFixed(1)}%`;
    
    // Analysis failure rate
    const totalAnalyzed = (emailStats.successfully_analyzed || 0) + 
                        (emailStats.failed_parsing || 0) + 
                        (emailStats.failed_analysis || 0);
    const failureRate = totalAnalyzed > 0 ? 
        (((emailStats.failed_parsing || 0) + (emailStats.failed_analysis || 0)) / totalAnalyzed * 100) : 0;
    document.getElementById('analysis-failure-rate').textContent = 
        `${failureRate.toFixed(1)}%`;
    
    // Combine needs_action and has_deadline into a single metric
    // If an email has a deadline, it implicitly needs action
    const actionRequired = Math.max(
        emailStats.needs_action || 0,
        emailStats.has_deadline || 0
    );
    document.getElementById('action-required').textContent = 
        actionRequired.toLocaleString();
    
    // Update NLP stats
    console.log('Updating NLP stats:', data.nlp_stats);
    document.getElementById('entities-extracted').textContent = (data.nlp_stats.total_entities || 0).toLocaleString();
    
    const urgencyRate = data.nlp_stats.total_emails ? 
        ((data.nlp_stats.urgent_emails / data.nlp_stats.total_emails) * 100) : 0;
    document.getElementById('urgent-emails').textContent = `${urgencyRate.toFixed(1)}%`;
    
    document.getElementById('avg-complexity').textContent = 
        Math.round(data.nlp_stats.avg_sentences_per_email || 0).toLocaleString();
    document.getElementById('avg-processing-time').textContent = 
        Math.round((data.nlp_stats.avg_processing_time || 0) * 1000);
    
    // Update LLM stats
    console.log('Updating LLM stats:', data.llm_stats);
    document.getElementById('total-tokens').textContent = (data.llm_stats.total_tokens || 0).toLocaleString();
    document.getElementById('total-requests').textContent = (data.llm_stats.total_requests || 0).toLocaleString();
    document.getElementById('total-cost').textContent = 
        `$${((data.llm_stats.total_cost_cents || 0) / 100).toFixed(2)}`;
    document.getElementById('success-rate').textContent = 
        `${(data.llm_stats.success_rate || 0).toFixed(1)}%`;
    
    // Per-request averages for LLM
    document.getElementById('avg-tokens-per-req').textContent = 
        Math.round(data.llm_stats.avg_tokens_per_request || 0).toLocaleString();
    document.getElementById('avg-cost-per-req').textContent = 
        `$${((data.llm_stats.avg_cost_cents_per_request || 0) / 100).toFixed(3)}`;
    document.getElementById('llm-avg-processing-time').textContent = 
        Math.round(data.llm_stats.avg_processing_time_ms || 0).toLocaleString();
    
    // Update activity list with animation
    const activityList = document.getElementById('activity-list');
    const newActivities = data.recent_activities.map(activity => `
        <li class="activity-item">
            <div class="activity-time">${new Date(activity.created_at).toLocaleString()}</div>
            <strong>${activity.type}</strong>: ${activity.description}
        </li>
    `).join('');
    
    if (activityList.innerHTML !== newActivities) {
        activityList.style.opacity = '0';
        setTimeout(() => {
            activityList.innerHTML = newActivities;
            activityList.style.opacity = '1';
        }, 300);
    }
    
    // Create charts with responsive layout
    createLLMChart(data.llm_stats);
    createModelDistributionChart(data.llm_stats);
    createEmailChart(data.email_stats);
    createNLPChart(data.nlp_stats);
}

function createLLMChart(stats) {
    const trace = {
        x: ['Total Tokens', 'Total Requests', 'Avg. Tokens/Req', 'Avg. Time (ms)'],
        y: [
            stats.total_tokens || 0,
            stats.total_requests || 0,
            stats.avg_tokens_per_request || 0,
            stats.avg_processing_time_ms || 0
        ],
        type: 'bar',
        marker: {
            color: ['#00918C', '#00B4AE', '#006F6A', '#008080']
        },
        text: [
            (stats.total_tokens || 0).toLocaleString(),
            (stats.total_requests || 0).toLocaleString(),
            Math.round(stats.avg_tokens_per_request || 0).toLocaleString(),
            Math.round(stats.avg_processing_time_ms || 0).toLocaleString()
        ],
        textposition: 'auto',
    };
    
    const layout = {
        title: 'LLM Performance Metrics',
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, r: 20, b: 80, l: 60 },
        responsive: true,
        yaxis: {
            type: 'log',  // Use log scale to handle different magnitudes
            title: 'Value (log scale)'
        }
    };
    
    const config = { responsive: true };
    
    Plotly.newPlot('llm-usage-chart', [trace], layout, config);
}

function createModelDistributionChart(stats) {
    const models = Object.keys(stats.requests_by_model || {});
    const tokensByModel = models.map(model => (stats.tokens_by_model || {})[model]?.total_tokens || 0);
    const requestsByModel = models.map(model => (stats.requests_by_model || {})[model] || 0);
    
    const tokenTrace = {
        x: models,
        y: tokensByModel,
        name: 'Total Tokens',
        type: 'bar',
        marker: { color: '#00918C' }
    };
    
    const requestTrace = {
        x: models,
        y: requestsByModel,
        name: 'Total Requests',
        yaxis: 'y2',
        type: 'scatter',
        mode: 'lines+markers',
        marker: { color: '#00B4AE' }
    };
    
    const layout = {
        title: 'Usage by Model Type',
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, r: 50, b: 60, l: 60 },
        yaxis: { 
            title: 'Total Tokens',
            titlefont: { color: '#00918C' },
            tickfont: { color: '#00918C' }
        },
        yaxis2: {
            title: 'Total Requests',
            titlefont: { color: '#00B4AE' },
            tickfont: { color: '#00B4AE' },
            overlaying: 'y',
            side: 'right'
        },
        showlegend: true,
        legend: {
            x: 0,
            y: 1.2
        },
        responsive: true,
        bargap: 0.3
    };
    
    const config = { responsive: true };
    
    Plotly.newPlot('llm-model-distribution', [tokenTrace, requestTrace], layout, config);
}

function createEmailChart(stats) {
    // Create category distribution chart
    const categoryTrace = {
        labels: Object.keys(stats.categories || {}),
        values: Object.values(stats.categories || {}),
        type: 'pie',
        name: 'Email Categories',
        domain: { row: 0, column: 0 },
        marker: {
            colors: [
                '#2563EB',  // Work - Professional deep blue
                '#16A34A',  // Personal - Forest green
                '#F97316',  // Promotions - Vibrant orange
                '#6366F1'   // Informational - Indigo
            ]
        }
    };
    
    // Create priority distribution chart
    const priorityTrace = {
        labels: ['HIGH', 'MEDIUM', 'LOW'].filter(level => (stats.priority_levels || {})[level] !== undefined),
        values: ['HIGH', 'MEDIUM', 'LOW'].map(level => (stats.priority_levels || {})[level] || 0),
        type: 'pie',
        name: 'Priority Levels',
        domain: { row: 0, column: 1 },
        marker: {
            colors: [
                '#FF4B4B',  // HIGH - Bright red
                '#FF8C42',  // MEDIUM - Orange
                '#66BB6A'   // LOW - Green
            ]
        }
    };
    
    const layout = {
        title: 'Email Distribution by Category and Priority',
        grid: { rows: 1, columns: 2 },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, r: 20, b: 40, l: 20 },
        responsive: true,
        showlegend: true,
        legend: { orientation: 'h' }
    };
    
    const config = { responsive: true };
    
    Plotly.newPlot('email-category-chart', [categoryTrace], {
        ...layout,
        title: 'Email Categories'
    }, config);
    
    Plotly.newPlot('email-priority-chart', [priorityTrace], {
        ...layout,
        title: 'Priority Distribution'
    }, config);
}

function createNLPChart(stats) {
    // Create two traces for our chart
    const entityTrace = {
        x: ['People', 'Organizations', 'Dates', 'Locations', 'Other'],
        y: [
            (stats.entity_types?.PERSON || 0),
            (stats.entity_types?.ORG || 0),
            (stats.entity_types?.DATE || 0),
            (stats.entity_types?.LOC || 0),
            (stats.entity_types?.MISC || 0)
        ],
        name: 'Entity Types',
        type: 'bar',
        marker: { color: '#006F6A' }
    };
    
    const totalEmails = stats.total_emails || 0;
    const urgentEmails = stats.urgent_emails || 0;
    
    const urgencyTrace = {
        labels: ['Urgent', 'Normal'],
        values: [urgentEmails, totalEmails - urgentEmails],
        name: 'Urgency Distribution',
        type: 'pie',
        domain: { row: 0, column: 1 },
        marker: {
            colors: ['#DC3545', '#006F6A']
        }
    };
    
    const layout = {
        title: 'NLP Analysis Breakdown',
        grid: { rows: 1, columns: 2 },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, r: 20, b: 40, l: 60 },
        responsive: true,
        showlegend: true,
        legend: { orientation: 'h' }
    };
    
    const config = { responsive: true };
    
    Plotly.newPlot('nlp-analytics-chart', [entityTrace, urgencyTrace], layout, config);
}

function refreshStats() {
    fetchAnalytics();
}

async function debugActivities() {
    try {
        console.log('Fetching debug activities...');
        const response = await fetch('/user/api/debug/activities');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`Found ${data.count} activities`);
        console.log('Raw activities:', data.activities);
        
        // Log specific activity types
        const activityTypes = data.activities.reduce((acc, activity) => {
            acc[activity.type] = (acc[activity.type] || 0) + 1;
            return acc;
        }, {});
        console.log('Activity types count:', activityTypes);
        
        // Log email processing activities specifically
        const emailActivities = data.activities.filter(a => 
            a.type === 'email_processing' || a.type === 'pipeline_processing'
        );
        console.log(`Found ${emailActivities.length} email processing activities:`);
        emailActivities.forEach((activity, index) => {
            console.log(`\nEmail Activity ${index + 1}:`);
            console.log('Type:', activity.type);
            console.log('Description:', activity.description);
            console.log('Metadata:', activity.metadata);
        });
        
    } catch (error) {
        console.error('Failed to fetch debug activities:', error);
    }
}

// Initial load
document.addEventListener('DOMContentLoaded', fetchAnalytics);

// Add window resize handler for charts
window.addEventListener('resize', () => {
    if (currentStats) {
        createLLMChart(currentStats.llm_stats);
        createModelDistributionChart(currentStats.llm_stats);
        createEmailChart(currentStats.email_stats);
        createNLPChart(currentStats.nlp_stats);
    }
});

// Refresh every 5 minutes
setInterval(fetchAnalytics, 5 * 60 * 1000);
</script>
{% endblock %} 