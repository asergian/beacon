{% extends "base.html" %}

{% block title %}Analytics Dashboard{% endblock %}

{% block styles %}
{{ super() }}
<style>
    :root {
        --header-height: 64px;
        --filter-height: 56px;
        --footer-height: 130px;
    }

    .header {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    .stats-container {
        padding: 2rem;
        margin-top: calc(var(--filter-height) + 1rem);
        background-color: #f4f7f9;
        overflow-y: auto;
        height: calc(100vh - var(--header-height) - var(--filter-height) - var(--footer-height));
        position: relative;
        display: grid;
        gap: 1.5rem;
    }
    
    .stats-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 1.5rem;
    }
    
    .stats-header {
        color: #006F6A;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .stats-header h2 {
        margin: 0;
        font-size: 1.5rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .stat-item {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
        transition: transform 0.2s ease;
    }
    
    .stat-item:hover {
        transform: translateY(-2px);
    }
    
    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #006F6A;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.5rem;
    }
    
    .chart-container {
        min-height: 400px;
        height: auto;
        margin-top: 1.5rem;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
    }
    
    .activity-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .activity-item {
        padding: 1rem;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s ease;
    }
    
    .activity-item:hover {
        background-color: #f8f9fa;
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
    
    .activity-time {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    
    .refresh-button {
        background: #006F6A;
        color: white;
        border: none;
        padding: 0.5rem 1.2rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
        min-width: 100px;
        height: 36px;
        line-height: 1;
    }
    
    .refresh-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }
    
    .refresh-button:not(:disabled):hover {
        background: #005753;
        transform: translateY(-1px);
    }
    
    .refresh-button:not(:disabled):active {
        transform: translateY(0);
    }
    
    .loading-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s linear infinite;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 10px;
    }
    
    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .charts-grid .chart-container {
        margin-top: 0;  /* Remove top margin since grid has its own gap */
    }
    
    .activity-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .activity-list-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
    }
    
    .activity-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .activity-item {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 1rem;
        padding: 1rem;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s ease;
        align-items: start;
    }
    
    .activity-item:hover {
        background-color: #fff;
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
    
    .activity-meta {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        min-width: 120px;
    }
    
    .activity-time {
        color: #666;
        font-size: 0.85rem;
    }
    
    .activity-type {
        font-size: 0.85rem;
        font-weight: 500;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        background: #e5e7eb;
        color: #374151;
        text-align: center;
    }
    
    .activity-type.email {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .activity-type.analysis {
        background: #dcfce7;
        color: #166534;
    }
    
    .activity-type.error {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .activity-content {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .activity-description {
        color: #374151;
        font-size: 0.95rem;
        line-height: 1.4;
    }
    
    .activity-metadata {
        font-size: 0.85rem;
        color: #6b7280;
    }
    
    .stats-card h2 {
        color: #006F6A;
        margin: 0;
        font-size: 1.5rem;
    }
    
    .analytics-filter-row {
        position: fixed;
        top: var(--header-height);
        left: 0;
        right: 0;
        height: var(--filter-height);
        background-color: #F1F3F5;
        border-bottom: 1px solid #ddd;
        z-index: 100;
        display: flex;
        align-items: center;
        padding: 0.5rem 2rem;
        gap: 2rem;
    }
    
    .section-toggles {
        display: flex;
        gap: 1.5rem;
        align-items: center;
    }
    
    .toggle-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .toggle-group label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #4a5568;
        font-size: 0.9rem;
        font-weight: 400;
        cursor: pointer;
    }
    
    .toggle-group input[type="checkbox"] {
        width: 1rem;
        height: 1rem;
        border-radius: 4px;
        border: 2px solid #006F6A;
        cursor: pointer;
        accent-color: #006F6A;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-filter-row">
    <div class="section-toggles">
        <div class="toggle-group">
            <label>
                <input type="checkbox" checked id="toggle-overview">
                System Overview
            </label>
        </div>
        <div class="toggle-group">
            <label>
                <input type="checkbox" checked id="toggle-email">
                Email Processing
            </label>
        </div>
        <div class="toggle-group">
            <label>
                <input type="checkbox" checked id="toggle-nlp">
                NLP Analytics
            </label>
        </div>
        <div class="toggle-group">
            <label>
                <input type="checkbox" checked id="toggle-llm">
                LLM Usage
            </label>
        </div>
        <div class="toggle-group">
            <label>
                <input type="checkbox" checked id="toggle-activity">
                User Activity
            </label>
        </div>
    </div>
</div>

<div class="stats-container">
    <div class="stats-card">
        <div class="stats-header">
            <h2>System Overview</h2>
            <button class="refresh-button" onclick="refreshAll()">Refresh All</button>
        </div>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="total-users">-</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="active-today">-</div>
                <div class="stat-label">Daily Active Users</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-emails-processed">-</div>
                <div class="stat-label">Total Emails Processed</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="system-success-rate">-</div>
                <div class="stat-label">System Success Rate</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-processing-time">-</div>
                <div class="stat-label">Avg Processing Time</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-cost">-</div>
                <div class="stat-label">Total Cost</div>
            </div>
        </div>
    </div>
    
    <div class="stats-card">
        <div class="stats-header">
            <h2>Email Processing Statistics</h2>
            <button class="refresh-button" onclick="refreshSection('Email Processing Statistics')">Refresh</button>
        </div>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="total-fetched">-</div>
                <div class="stat-label">Total Fetched</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="cache-hit-rate">-</div>
                <div class="stat-label">Cache Hit Rate</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="analysis-failure-rate">-</div>
                <div class="stat-label">Analysis Failure Rate</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="action-required">-</div>
                <div class="stat-label">Action Required</div>
            </div>
        </div>
        <div class="charts-grid">
            <div class="chart-container" id="email-category-chart"></div>
            <div class="chart-container" id="email-priority-chart"></div>
        </div>
    </div>
    
    <div class="stats-card">
        <div class="stats-header">
            <h2>NLP Analytics</h2>
            <button class="refresh-button" onclick="refreshSection('NLP Analytics')">Refresh</button>
        </div>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="entities-extracted">-</div>
                <div class="stat-label">Total Entities</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="urgent-emails">-</div>
                <div class="stat-label">Urgent Emails (%)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avg-complexity">-</div>
                <div class="stat-label">Avg. Sentences/Email</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avg-processing-time">-</div>
                <div class="stat-label">Avg. Processing Time (ms)</div>
            </div>
        </div>
        <div class="charts-grid">
            <div class="chart-container" id="nlp-entities-chart"></div>
            <div class="chart-container" id="nlp-urgency-chart"></div>
        </div>
    </div>
    
    <div class="stats-card">
        <div class="stats-header">
            <h2>LLM Usage Statistics</h2>
            <button class="refresh-button" onclick="refreshSection('LLM Usage Statistics')">Refresh</button>
        </div>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="total-tokens">-</div>
                <div class="stat-label">Total Tokens</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-requests">-</div>
                <div class="stat-label">Total Requests</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="success-rate">-</div>
                <div class="stat-label">Success Rate</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="llm-total-cost">-</div>
                <div class="stat-label">Total Cost ($)</div>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="avg-tokens-per-req">-</div>
                <div class="stat-label">Avg. Tokens/Request</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avg-cost-per-req">-</div>
                <div class="stat-label">Avg. Cost/Request</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="llm-avg-processing-time">-</div>
                <div class="stat-label">Avg. Processing Time (ms)</div>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="chart-container" id="llm-usage-chart"></div>
            <div class="chart-container" id="llm-model-distribution"></div>
        </div>
    </div>
    
    <div class="stats-card">
        <div class="stats-header">
            <h2>User Activity & Analytics</h2>
            <button class="refresh-button" onclick="refreshSection('User Activity & Analytics')">Refresh</button>
        </div>
        
        <div class="activity-stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="activity-total-users">-</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="activity-active-users">-</div>
                <div class="stat-label">Active Users</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="activity-active-today">-</div>
                <div class="stat-label">Active Today</div>
            </div>
        </div>
        
        <div class="activity-list-container">
            <div class="activity-list" id="activity-list">
            <!-- Activities will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
let currentStats = null;
let isLoading = false;

// Add section visibility state
const sectionVisibility = {
    overview: true,
    llm: true,
    email: true,
    nlp: true,
    activity: true
};

async function fetchAnalytics() {
    if (isLoading) return;
    
    try {
        isLoading = true;
        updateLoadingState(true);
        
        const response = await fetch('/user/api/analytics');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        if (data.error) {
            throw new Error(data.error);
        }
        
        currentStats = data;
        updateDashboard(data);
        updateLoadingState(false);
    } catch (error) {
        console.error('Failed to fetch analytics:', error);
        showError(error.message);
        updateLoadingState(false);
    } finally {
        isLoading = false;
    }
}

function updateLoadingState(loading) {
    const button = document.querySelector('.refresh-button');
    if (loading) {
        button.innerHTML = '<span class="loading-spinner"></span> Loading...';
        button.disabled = true;
    } else {
        button.innerHTML = 'Refresh';
        button.disabled = false;
    }
}

function showError(message) {
    // Create error element if it doesn't exist
    let errorEl = document.getElementById('error-message');
    if (!errorEl) {
        errorEl = document.createElement('div');
        errorEl.id = 'error-message';
        errorEl.className = 'error-message';
        document.querySelector('.stats-container').prepend(errorEl);
    }
    
    errorEl.innerHTML = `
        <div class="error-content">
            <strong>Error loading analytics:</strong>
            <p>${message}</p>
            <button onclick="fetchAnalytics()" class="refresh-button">Retry</button>
        </div>
    `;
    errorEl.style.display = 'block';
}

function updateDashboard(data) {
    console.log('Received analytics data:', data);
    
    // Hide any existing error message
    const errorEl = document.getElementById('error-message');
    if (errorEl) {
        errorEl.style.display = 'none';
    }
    
    // Update system overview stats
    const userStats = data.user_stats || {};
    const emailStats = data.email_stats || {};
    const nlpStats = data.nlp_stats || {};
    const llmStats = data.llm_stats || {};
    
    // User stats in overview
    document.getElementById('total-users').textContent = 
        (userStats.total_users || 0).toLocaleString();
    document.getElementById('active-today').textContent = 
        (userStats.active_today || 0).toLocaleString();
    
    // Total emails processed in overview
    document.getElementById('total-emails-processed').textContent = 
        (emailStats.total_fetched || 0).toLocaleString();
    
    // Overall system success rate (combine email and LLM success rates)
    const emailSuccessRate = emailStats.total_fetched ? 
        ((emailStats.successfully_analyzed || 0) / emailStats.total_fetched * 100) : 0;
    const llmSuccessRate = llmStats.success_rate || 0;
    const systemSuccessRate = (emailSuccessRate + llmSuccessRate) / 2;
    document.getElementById('system-success-rate').textContent = 
        `${systemSuccessRate.toFixed(1)}%`;
    
    // Total processing time (NLP + LLM)
    const totalProcessingTime = 
        (nlpStats.avg_processing_time || 0) * 1000 + 
        (llmStats.avg_processing_time_ms || 0);
    document.getElementById('total-processing-time').textContent = 
        `${Math.round(totalProcessingTime)}ms`;
    
    // Total cost in overview
    document.getElementById('total-cost').textContent = 
        `$${((llmStats.total_cost_cents || 0) / 100).toFixed(2)}`;
    
    // Update LLM stats section
    document.getElementById('total-tokens').textContent = 
        (llmStats.total_tokens || 0).toLocaleString();
    document.getElementById('total-requests').textContent = 
        (llmStats.total_requests || 0).toLocaleString();
    document.getElementById('llm-total-cost').textContent = 
        `$${((llmStats.total_cost_cents || 0) / 100).toFixed(2)}`;
    document.getElementById('success-rate').textContent = 
        `${(llmStats.success_rate || 0).toFixed(1)}%`;
    
    // Per-request averages for LLM
    document.getElementById('avg-tokens-per-req').textContent = 
        Math.round(llmStats.avg_tokens_per_request || 0).toLocaleString();
    document.getElementById('avg-cost-per-req').textContent = 
        `$${((llmStats.avg_cost_cents_per_request || 0) / 100).toFixed(3)}`;
    document.getElementById('llm-avg-processing-time').textContent = 
        Math.round(llmStats.avg_processing_time_ms || 0).toLocaleString();
    
    // Update email stats section
    document.getElementById('total-fetched').textContent = 
        (emailStats.total_fetched || 0).toLocaleString();
    
    // Cache hit rate (inverse of new emails rate)
    const totalFetched = emailStats.total_fetched || 0;
    const newEmails = emailStats.new_emails || 0;
    const cacheHitRate = totalFetched > 0 ? 
        ((totalFetched - newEmails) / totalFetched * 100) : 0;
    document.getElementById('cache-hit-rate').textContent = 
        `${cacheHitRate.toFixed(1)}%`;
    
    // Analysis failure rate
    const totalAnalyzed = (emailStats.successfully_analyzed || 0) + 
                        (emailStats.failed_parsing || 0) + 
                        (emailStats.failed_analysis || 0);
    const failureRate = totalAnalyzed > 0 ? 
        (((emailStats.failed_parsing || 0) + (emailStats.failed_analysis || 0)) / totalAnalyzed * 100) : 0;
    document.getElementById('analysis-failure-rate').textContent = 
        `${failureRate.toFixed(1)}%`;
    
    // Action required (combine needs_action and has_deadline)
    const actionRequired = Math.max(
        emailStats.needs_action || 0,
        emailStats.has_deadline || 0
    );
    document.getElementById('action-required').textContent = 
        actionRequired.toLocaleString();
    
    // Update user activity section with user stats
    document.getElementById('activity-total-users').textContent = 
        (userStats.total_users || 0).toLocaleString();
    document.getElementById('activity-active-users').textContent = 
        (userStats.active_users || 0).toLocaleString();
    document.getElementById('activity-active-today').textContent = 
        (userStats.active_today || 0).toLocaleString();
    
    // Update NLP stats
    console.log('Updating NLP stats:', data.nlp_stats);
    document.getElementById('entities-extracted').textContent = (data.nlp_stats.total_entities || 0).toLocaleString();
    
    const urgencyRate = data.nlp_stats.total_emails ? 
        ((data.nlp_stats.urgent_emails / data.nlp_stats.total_emails) * 100) : 0;
    document.getElementById('urgent-emails').textContent = `${urgencyRate.toFixed(1)}%`;
    
    document.getElementById('avg-complexity').textContent = 
        Math.round(data.nlp_stats.avg_sentences_per_email || 0).toLocaleString();
    document.getElementById('avg-processing-time').textContent = 
        Math.round((data.nlp_stats.avg_processing_time || 0) * 1000);
    
    // Update activity stats
    const activityList = document.getElementById('activity-list');
    const newActivities = data.recent_activities.map(activity => {
        const activityType = getActivityType(activity.type);
        const metadata = activity.metadata ? formatMetadata(activity.metadata) : '';
        
        return `
        <li class="activity-item">
                <div class="activity-meta">
            <div class="activity-time">${new Date(activity.created_at).toLocaleString()}</div>
                    <div class="activity-type ${activityType.class}">${activityType.label}</div>
                </div>
                <div class="activity-content">
                    <div class="activity-description">${activity.description}</div>
                    ${metadata ? `<div class="activity-metadata">${metadata}</div>` : ''}
                </div>
        </li>
        `;
    }).join('');
    
    if (activityList.innerHTML !== newActivities) {
        activityList.style.opacity = '0';
        setTimeout(() => {
            activityList.innerHTML = newActivities;
            activityList.style.opacity = '1';
        }, 300);
    }
    
    // Create charts with responsive layout
    createLLMChart(data.llm_stats);
    createModelDistributionChart(data.llm_stats);
    createEmailChart(data.email_stats);
    createNLPChart(data.nlp_stats);
}

function createLLMChart(stats) {
    const trace = {
        x: ['Total Tokens', 'Total Requests', 'Avg. Tokens/Req', 'Avg. Time (ms)'],
        y: [
            stats.total_tokens || 0,
            stats.total_requests || 0,
            stats.avg_tokens_per_request || 0,
            stats.avg_processing_time_ms || 0
        ],
        type: 'bar',
        marker: {
            color: [
                '#2563EB',  // Deep blue for Tokens
                '#16A34A',  // Forest green for Requests
                '#F97316',  // Vibrant orange for Avg Tokens
                '#6366F1'   // Indigo for Avg Time
            ]
        },
        text: [
            (stats.total_tokens || 0).toLocaleString(),
            (stats.total_requests || 0).toLocaleString(),
            Math.round(stats.avg_tokens_per_request || 0).toLocaleString(),
            Math.round(stats.avg_processing_time_ms || 0).toLocaleString()
        ],
        textposition: 'auto',
    };
    
    const layout = {
        title: {
            text: 'Performance Metrics',
            font: { size: 16 },
            y: 0.98
        },
        height: 400,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { 
            t: 40,
            r: 20, 
            b: 100,
            l: 60 
        },
        yaxis: {
            type: 'log',
            title: 'Value (log scale)'
        }
    };
    
    const config = { 
        responsive: true,
        displayModeBar: false
    };
    
    Plotly.newPlot('llm-usage-chart', [trace], layout, config);
}

function createModelDistributionChart(stats) {
    const models = Object.keys(stats.requests_by_model || {});
    const tokensByModel = models.map(model => (stats.tokens_by_model || {})[model]?.total_tokens || 0);
    const requestsByModel = models.map(model => (stats.requests_by_model || {})[model] || 0);
    
    const tokenTrace = {
        x: models,
        y: tokensByModel,
        name: 'Total Tokens',
        type: 'bar',
        marker: { color: '#3B82F6' }  // Blue for tokens
    };
    
    const requestTrace = {
        x: models,
        y: requestsByModel,
        name: 'Total Requests',
        yaxis: 'y2',
        type: 'scatter',
        mode: 'lines+markers',
        marker: { color: '#10B981' }  // Green for requests
    };
    
    const layout = {
        title: {
            text: 'Model Usage Distribution',
            font: { size: 16 },
            y: 0.98
        },
        height: 400,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { 
            t: 40,
            r: 50, 
            b: 100,
            l: 60 
        },
        yaxis: { 
            title: 'Total Tokens',
            titlefont: { color: '#3B82F6' },
            tickfont: { color: '#3B82F6' }
        },
        yaxis2: {
            title: 'Total Requests',
            titlefont: { color: '#10B981' },
            tickfont: { color: '#10B981' },
            overlaying: 'y',
            side: 'right'
        },
        showlegend: true,
        legend: {
            orientation: 'h',
            y: -0.2,
            xanchor: 'center',
            x: 0.5
        },
        bargap: 0.3
    };
    
    const config = { 
        responsive: true,
        displayModeBar: false
    };
    
    Plotly.newPlot('llm-model-distribution', [tokenTrace, requestTrace], layout, config);
}

function createEmailChart(stats) {
    // Create category distribution chart
    const categoryTrace = {
        labels: Object.keys(stats.categories || {}),
        values: Object.values(stats.categories || {}),
        type: 'pie',
        name: 'Categories',
        marker: {
            colors: [
                '#2563EB',  // Work - Professional deep blue
                '#16A34A',  // Personal - Forest green
                '#F97316',  // Promotions - Vibrant orange
                '#6366F1'   // Informational - Indigo
            ]
        },
        hole: 0.25
    };
    
    // Create priority distribution chart
    const priorityTrace = {
        labels: ['High', 'Medium', 'Low'].filter(level => (stats.priority_levels || {})[level.toUpperCase()] !== undefined),
        values: ['HIGH', 'MEDIUM', 'LOW'].map(level => (stats.priority_levels || {})[level] || 0),
        type: 'pie',
        name: 'Priorities',
        marker: {
            colors: [
                '#FF4B4B',  // HIGH - Bright red
                '#FF8C42',  // MEDIUM - Orange
                '#66BB6A'   // LOW - Green
            ]
        },
        hole: 0.25
    };
    
    const baseLayout = {
        height: 400,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { 
            t: 40,
            r: 20, 
            b: 100,
            l: 20 
        },
        showlegend: true,
        legend: {
            orientation: 'h',
            y: -0.2,
            xanchor: 'center',
            x: 0.5
        }
    };
    
    const config = { 
        responsive: true,
        displayModeBar: false
    };
    
    // Create separate charts with titles
    Plotly.newPlot('email-category-chart', [categoryTrace], {
        ...baseLayout,
        title: {
            text: 'Categories',
            font: { size: 16 },
            y: 0.98
        }
    }, config);
    
    Plotly.newPlot('email-priority-chart', [priorityTrace], {
        ...baseLayout,
        title: {
            text: 'Priorities',
            font: { size: 16 },
            y: 0.98
        }
    }, config);
}

function createNLPChart(stats) {
    // Entity Types Bar Chart
    const entityTrace = {
        x: ['People', 'Organizations', 'Dates', 'Locations', 'Other'],
        y: [
            (stats.entity_types?.PERSON || 0),
            (stats.entity_types?.ORG || 0),
            (stats.entity_types?.DATE || 0),
            (stats.entity_types?.LOC || 0),
            (stats.entity_types?.MISC || 0)
        ],
        name: 'Entity Types',
        type: 'bar',
        marker: {
            color: [
                '#3B82F6',  // Blue for People
                '#10B981',  // Green for Organizations
                '#F59E0B',  // Amber for Dates
                '#6366F1',  // Indigo for Locations
                '#8B5CF6'   // Purple for Other
            ]
        }
    };
    
    const entityLayout = {
        title: {
            text: 'Entity Distribution',
            font: { size: 16 },
            y: 0.98
        },
        height: 400,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { 
            t: 40,
            r: 20, 
            b: 100,
            l: 60 
        },
        showlegend: false,
        yaxis: {
            title: 'Count'
        }
    };

    // Urgency Distribution Pie Chart
    const totalEmails = stats.total_emails || 0;
    const urgentEmails = stats.urgent_emails || 0;
    
    const urgencyTrace = {
        labels: ['Urgent', 'Normal'],
        values: [urgentEmails, totalEmails - urgentEmails],
        name: 'Urgency Distribution',
        type: 'pie',
        marker: {
            colors: [
                '#EF4444',  // Red for Urgent
                '#6B7280'   // Gray for Normal
            ]
        },
        hole: 0.25
    };
    
    const urgencyLayout = {
        title: {
            text: 'Urgency Distribution',
            font: { size: 16 },
            y: 0.98
        },
        height: 400,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { 
            t: 40,
            r: 20, 
            b: 100,
            l: 20 
        },
        showlegend: true,
        legend: {
            orientation: 'h',
            y: -0.2,
            xanchor: 'center',
            x: 0.5
        }
    };
    
    const config = { 
        responsive: true,
        displayModeBar: false
    };
    
    // Create separate charts
    Plotly.newPlot('nlp-entities-chart', [entityTrace], entityLayout, config);
    Plotly.newPlot('nlp-urgency-chart', [urgencyTrace], urgencyLayout, config);
}

async function refreshSection(section) {
    if (isLoading) return;
    
    // Find the button by finding the header with matching text and then its refresh button
    const header = Array.from(document.querySelectorAll('.stats-header'))
        .find(header => header.querySelector('h2').textContent === section);
    const button = header ? header.querySelector('.refresh-button') : null;
    
    if (!button) return;
    
    try {
        isLoading = true;
        updateLoadingState(true, button);
        
        const response = await fetch('/user/api/analytics');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Update only the specific section
        switch(section) {
            case 'System Overview':
                updateOverviewStats(data);
                break;
            case 'LLM Usage Statistics':
                updateLLMStats(data);
                createLLMChart(data.llm_stats);
                createModelDistributionChart(data.llm_stats);
                break;
            case 'Email Processing Statistics':
                updateEmailStats(data);
                createEmailChart(data.email_stats);
                break;
            case 'NLP Analytics':
                updateNLPStats(data);
                createNLPChart(data.nlp_stats);
                break;
            case 'User Activity & Analytics':
                updateActivityStats(data);
                break;
        }
    } catch (error) {
        console.error(`Failed to refresh ${section} section:`, error);
        showError(error.message);
    } finally {
        updateLoadingState(false, button);
        isLoading = false;
    }
}

function updateLoadingState(loading, button) {
    if (!button) return;
    
    const originalText = button.getAttribute('data-original-text') || 'Refresh';
    
    if (loading) {
        // Store the original text if not already stored
        if (!button.getAttribute('data-original-text')) {
            button.setAttribute('data-original-text', button.textContent);
        }
        button.innerHTML = '<span class="loading-spinner"></span> Loading...';
        button.disabled = true;
        button.style.opacity = '0.7';
        button.style.cursor = 'not-allowed';
    } else {
        button.innerHTML = originalText;
        button.disabled = false;
        button.style.opacity = '1';
        button.style.cursor = 'pointer';
    }
}

function updateOverviewStats(data) {
    const userStats = data.user_stats || {};
    const emailStats = data.email_stats || {};
    const nlpStats = data.nlp_stats || {};
    const llmStats = data.llm_stats || {};
    
    document.getElementById('total-users').textContent = 
        (userStats.total_users || 0).toLocaleString();
    document.getElementById('active-today').textContent = 
        (userStats.active_today || 0).toLocaleString();
    document.getElementById('total-emails-processed').textContent = 
        (emailStats.total_fetched || 0).toLocaleString();
    
    const emailSuccessRate = emailStats.total_fetched ? 
        ((emailStats.successfully_analyzed || 0) / emailStats.total_fetched * 100) : 0;
    const llmSuccessRate = llmStats.success_rate || 0;
    const systemSuccessRate = (emailSuccessRate + llmSuccessRate) / 2;
    document.getElementById('system-success-rate').textContent = 
        `${systemSuccessRate.toFixed(1)}%`;
    
    const totalProcessingTime = 
        (nlpStats.avg_processing_time || 0) * 1000 + 
        (llmStats.avg_processing_time_ms || 0);
    document.getElementById('total-processing-time').textContent = 
        `${Math.round(totalProcessingTime)}ms`;
    
    document.getElementById('total-cost').textContent = 
        `$${((llmStats.total_cost_cents || 0) / 100).toFixed(2)}`;
}

function updateLLMStats(data) {
    const llmStats = data.llm_stats || {};
    
    document.getElementById('total-tokens').textContent = 
        (llmStats.total_tokens || 0).toLocaleString();
    document.getElementById('total-requests').textContent = 
        (llmStats.total_requests || 0).toLocaleString();
    document.getElementById('llm-total-cost').textContent = 
        `$${((llmStats.total_cost_cents || 0) / 100).toFixed(2)}`;
    document.getElementById('success-rate').textContent = 
        `${(llmStats.success_rate || 0).toFixed(1)}%`;
    
    document.getElementById('avg-tokens-per-req').textContent = 
        Math.round(llmStats.avg_tokens_per_request || 0).toLocaleString();
    document.getElementById('avg-cost-per-req').textContent = 
        `$${((llmStats.avg_cost_cents_per_request || 0) / 100).toFixed(3)}`;
    document.getElementById('llm-avg-processing-time').textContent = 
        Math.round(llmStats.avg_processing_time_ms || 0).toLocaleString();
}

function updateEmailStats(data) {
    const emailStats = data.email_stats || {};
    const totalFetched = emailStats.total_fetched || 0;
    const newEmails = emailStats.new_emails || 0;
    const failedParsing = emailStats.failed_parsing || 0;
    const failedAnalysis = emailStats.failed_analysis || 0;
    
    document.getElementById('total-fetched').textContent = 
        totalFetched.toLocaleString();
    
    // Fix cache hit rate calculation and rounding
    const cacheHitRate = totalFetched > 0 ? 
        ((totalFetched - newEmails) / totalFetched * 100) : 0;
    document.getElementById('cache-hit-rate').textContent = 
        `${cacheHitRate.toFixed(1)}%`;
    
    // Fix analysis failure rate calculation and rounding
    const totalAnalyzed = totalFetched;
    const failureRate = totalAnalyzed > 0 ? 
        ((failedParsing + failedAnalysis) / totalAnalyzed * 100) : 0;
    document.getElementById('analysis-failure-rate').textContent = 
        `${failureRate.toFixed(1)}%`;
    
    document.getElementById('action-required').textContent = 
        Math.max(emailStats.needs_action || 0, emailStats.has_deadline || 0).toLocaleString();
}

function updateNLPStats(data) {
    const nlpStats = data.nlp_stats || {};
    const totalEmails = nlpStats.total_emails || 0;
    const urgentEmails = nlpStats.urgent_emails || 0;
    
    document.getElementById('entities-extracted').textContent = 
        (nlpStats.total_entities || 0).toLocaleString();
    
    // Fix urgent emails percentage calculation and rounding
    const urgentRate = totalEmails > 0 ? (urgentEmails / totalEmails * 100) : 0;
    document.getElementById('urgent-emails').textContent = 
        `${urgentRate.toFixed(1)}%`;
    
    document.getElementById('avg-complexity').textContent = 
        Math.round(nlpStats.avg_sentences_per_email || 0).toLocaleString();
    document.getElementById('avg-processing-time').textContent = 
        Math.round((nlpStats.avg_processing_time || 0) * 1000).toLocaleString();
}

function updateActivityStats(data) {
    const userStats = data.user_stats || {};
    
    document.getElementById('activity-total-users').textContent = 
        (userStats.total_users || 0).toLocaleString();
    document.getElementById('activity-active-users').textContent = 
        (userStats.active_users || 0).toLocaleString();
    document.getElementById('activity-active-today').textContent = 
        (userStats.active_today || 0).toLocaleString();
}

function getActivityType(type) {
    switch (type.toLowerCase()) {
        case 'email_processing':
        case 'email_analysis':
            return { class: 'email', label: 'Email' };
        case 'pipeline_processing':
        case 'nlp_analysis':
            return { class: 'analysis', label: 'Analysis' };
        case 'error':
        case 'failure':
            return { class: 'error', label: 'Error' };
        default:
            return { class: '', label: 'Activity' };
    }
}

function formatMetadata(metadata) {
    if (!metadata || typeof metadata !== 'object') return '';
    
    const formattedParts = [];
    
    // Handle email processing stats
    if (metadata.stats) {
        const stats = metadata.stats;
        const parts = [];
        if (stats.total_fetched || stats.emails_fetched) {
            parts.push(`${stats.total_fetched || stats.emails_fetched} fetched`);
        }
        if (stats.successfully_analyzed) {
            parts.push(`${stats.successfully_analyzed} analyzed`);
        }
        if (stats.failed_parsing || stats.failed_analysis) {
            const failed = (stats.failed_parsing || 0) + (stats.failed_analysis || 0);
            if (failed > 0) parts.push(`${failed} failed`);
        }
        if (parts.length > 0) {
            formattedParts.push(parts.join(' • '));
        }
    }
    
    // Handle NLP analysis
    if (metadata.entities) {
        const entityCount = Object.keys(metadata.entities).length;
        const entityTypes = Object.entries(metadata.entities)
            .map(([type, count]) => `${count} ${type.toLowerCase()}`)
            .join(', ');
        formattedParts.push(`Entities: ${entityTypes}`);
    }
    
    // Handle LLM requests
    if (metadata.model) {
        const parts = [`Model: ${metadata.model}`];
        if (metadata.total_tokens) {
            parts.push(`${metadata.total_tokens.toLocaleString()} tokens`);
        }
        if (metadata.processing_time_ms || metadata.processing_time) {
            const time = metadata.processing_time_ms || (metadata.processing_time * 1000);
            parts.push(`${Math.round(time)}ms`);
        }
        formattedParts.push(parts.join(' • '));
    }
    
    // Handle email metadata
    if (metadata.category || metadata.priority || metadata.is_urgent) {
        const parts = [];
        if (metadata.category) parts.push(`Category: ${metadata.category}`);
        if (metadata.priority) parts.push(`Priority: ${metadata.priority}`);
        if (metadata.is_urgent) parts.push('Urgent');
        formattedParts.push(parts.join(' • '));
    }
    
    // Handle user info
    if (metadata.user_email || metadata.user_name) {
        const parts = [];
        if (metadata.user_name) parts.push(metadata.user_name);
        if (metadata.user_email) parts.push(metadata.user_email);
        formattedParts.push(parts.join(' - '));
    }
    
    return formattedParts.filter(part => part).join(' • ');
}

// Initialize section toggles
function initializeSectionToggles() {
    const sections = {
        overview: document.querySelector('.stats-card:nth-child(1)'),
        email: document.querySelector('.stats-card:nth-child(2)'),
        nlp: document.querySelector('.stats-card:nth-child(3)'),
        llm: document.querySelector('.stats-card:nth-child(4)'),
        activity: document.querySelector('.stats-card:nth-child(5)')
    };
    
    Object.entries(sections).forEach(([key, section]) => {
        const toggle = document.getElementById(`toggle-${key}`);
        if (toggle && section) {
            toggle.addEventListener('change', (e) => {
                sectionVisibility[key] = e.target.checked;
                section.style.display = e.target.checked ? 'block' : 'none';
                // Trigger resize event to redraw charts if section becomes visible
                if (e.target.checked && currentStats) {
                    window.dispatchEvent(new Event('resize'));
                }
            });
        }
    });
}

// Add to DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
    fetchAnalytics();
    initializeSectionToggles();
});

// Add window resize handler for charts
window.addEventListener('resize', () => {
    if (currentStats) {
        createLLMChart(currentStats.llm_stats);
        createModelDistributionChart(currentStats.llm_stats);
        createEmailChart(currentStats.email_stats);
        createNLPChart(currentStats.nlp_stats);
    }
});

// Refresh every 5 minutes
setInterval(fetchAnalytics, 5 * 60 * 1000);

async function refreshAll() {
    if (isLoading) return;
    
    const button = document.querySelector('.stats-card:first-child .refresh-button');
    if (!button) return;
    
    try {
        isLoading = true;
        updateLoadingState(true, button);
        
        const response = await fetch('/user/api/analytics');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Update all sections
        updateOverviewStats(data);
        updateLLMStats(data);
        updateEmailStats(data);
        updateNLPStats(data);
        updateActivityStats(data);
        
        // Update all charts
        createLLMChart(data.llm_stats);
        createModelDistributionChart(data.llm_stats);
        createEmailChart(data.email_stats);
        createNLPChart(data.nlp_stats);
        
    } catch (error) {
        console.error('Failed to refresh all sections:', error);
        showError(error.message);
    } finally {
        updateLoadingState(false, button);
        isLoading = false;
    }
}
</script>
{% endblock %} 