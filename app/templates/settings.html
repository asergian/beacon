{% extends "base.html" %}

{% block title %}Beacon | Settings{% endblock %}

{% block content %}
<div class="settings-container">
    <h1 class="settings-title">Settings</h1>
    
    <div class="settings-section">
        <h2 class="section-title">General Settings</h2>
        <div class="setting-group">
            <div class="setting-item">
                <div class="setting-content">
                    <div class="setting-info">
                        <span class="setting-title">Dark Theme</span>
                        <span class="setting-description">Switch between light and dark mode</span>
                    </div>
                    <div class="toggle-container">
                        <input type="checkbox" 
                               name="theme" 
                               id="theme"
                               {% if user_settings.theme == 'dark' %}checked{% endif %}
                        >
                        <span class="toggle-switch"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="settings-section">
        <h2 class="section-title">Email Processing</h2>
        
        <div class="setting-group">
            <h3 class="group-title">Email Preferences</h3>
            <div class="setting-item">
                <div class="setting-content">
                    <div class="setting-info">
                        <span class="setting-title">Priority Threshold</span>
                        <span class="setting-description">Minimum priority level for email notifications (0-100)</span>
                    </div>
                    <input type="number" 
                           name="email_preferences.priority_threshold" 
                           id="priority_threshold"
                           min="0" 
                           max="100" 
                           value="{{ user_settings.email_preferences.priority_threshold }}"
                           class="form-input">
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-content">
                    <div class="setting-info">
                        <span class="setting-title">Days to Analyze</span>
                        <span class="setting-description">Number of days of emails to analyze</span>
                    </div>
                    <input type="number" 
                           name="email_preferences.days_to_analyze" 
                           id="days_to_analyze"
                           min="1" 
                           max="30" 
                           value="{{ user_settings.email_preferences.days_to_analyze }}"
                           class="form-input">
                </div>
            </div>
        </div>
        
        <div class="setting-group">
            <h3 class="group-title">AI Features</h3>
            <div class="setting-item">
                <div class="setting-content">
                    <div class="setting-info">
                        <span class="setting-title">AI Email Summarization</span>
                        <span class="setting-description">Generate AI-powered summaries of your emails</span>
                    </div>
                    <div class="toggle-container">
                        <input type="checkbox" 
                               name="ai_features.enable_ai_summarization" 
                               id="enable_ai_summarization"
                               {% if user_settings.ai_features.enable_ai_summarization %}checked{% endif %}
                        >
                        <span class="toggle-switch"></span>
                    </div>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-content">
                    <div class="setting-info">
                        <span class="setting-title">Summary Length</span>
                        <span class="setting-description">Length of generated email summaries</span>
                    </div>
                    <select id="summary_length" name="ai_features.summary_length" class="form-select">
                        <option value="short" {% if user_settings.ai_features.summary_length == 'short' %}selected{% endif %}>Short</option>
                        <option value="medium" {% if user_settings.ai_features.summary_length == 'medium' %}selected{% endif %}>Medium</option>
                        <option value="long" {% if user_settings.ai_features.summary_length == 'long' %}selected{% endif %}>Long</option>
                    </select>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-content">
                    <div class="setting-info">
                        <span class="setting-title">Action Item Detection</span>
                        <span class="setting-description">Automatically detect action items in emails</span>
                    </div>
                    <div class="toggle-container">
                        <input type="checkbox" 
                               name="ai_features.action_item_detection" 
                               id="action_item_detection"
                               {% if user_settings.ai_features.action_item_detection %}checked{% endif %}
                        >
                        <span class="toggle-switch"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    body {
        min-height: 100vh;
        margin: 0;
        padding: 0;
        overflow-y: auto;
        background-color: var(--bg-color);
        color: var(--text-color);
    }

    :root {
        /* Light theme variables */
        --bg-color: #f5f7fa;
        --text-color: #2c3e50;
        --card-bg: #ffffff;
        --card-shadow: 0 2px 8px rgba(0,0,0,0.05);
        --input-bg: #ffffff;
        --input-border: #e2e8f0;
        --input-text: #2c3e50;
        --setting-item-bg: #f8f9fa;
        --setting-item-hover: #f0f2f5;
        --toggle-bg: #e2e8f0;
        --toggle-active: #3b82f6;
        --description-color: #6c757d;
    }

    [data-theme="dark"] {
        --bg-color: #1a1a1a;
        --text-color: #e2e8f0;
        --card-bg: #2d2d2d;
        --card-shadow: 0 2px 8px rgba(0,0,0,0.2);
        --input-bg: #3d3d3d;
        --input-border: #4a4a4a;
        --input-text: #e2e8f0;
        --setting-item-bg: #363636;
        --setting-item-hover: #404040;
        --toggle-bg: #4a4a4a;
        --toggle-active: #3b82f6;
        --description-color: #a0aec0;
    }

    .main-content {
        min-height: calc(100vh - 160px);
        padding: 20px 0;
        overflow-y: auto;
    }
    
    .settings-container {
        max-width: 800px;
        margin: 2rem auto;
        margin-bottom: 4rem;
        padding: 0 1rem;
    }
    
    .settings-title {
        font-size: 2rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 2rem;
    }
    
    .settings-section {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 2rem;
        margin: 1.5rem 0;
        box-shadow: var(--card-shadow);
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 1.5rem;
    }
    
    .group-title {
        font-size: 1.2rem;
        font-weight: 500;
        color: var(--text-color);
        margin: 1.5rem 0 1rem;
    }
    
    .setting-group {
        margin-bottom: 2rem;
    }
    
    .setting-item {
        padding: 1rem;
        border-radius: 8px;
        background: var(--setting-item-bg);
        margin-bottom: 1rem;
        transition: background-color 0.2s ease;
    }
    
    .setting-item:hover {
        background: var(--setting-item-hover);
    }
    
    .setting-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;
    }
    
    .setting-info {
        flex: 1;
    }
    
    .setting-title {
        display: block;
        font-weight: 500;
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }
    
    .setting-description {
        display: block;
        font-size: 0.875rem;
        color: var(--description-color);
    }
    
    .toggle-container {
        position: relative;
        width: 50px;
        height: 26px;
        flex-shrink: 0;
        cursor: pointer;
    }
    
    .toggle-container input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
        z-index: 2;
        margin: 0;
    }
    
    .toggle-switch {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--toggle-bg);
        transition: .4s;
        border-radius: 34px;
        z-index: 1;
    }
    
    .toggle-switch:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        z-index: 1;
    }
    
    input:checked + .toggle-switch {
        background-color: var(--toggle-active);
    }
    
    input:checked + .toggle-switch:before {
        transform: translateX(24px);
    }
    
    .form-select, .form-input {
        padding: 0.5rem 1rem;
        border: 1px solid var(--input-border);
        border-radius: 6px;
        min-width: 120px;
        background-color: var(--input-bg);
        color: var(--input-text);
        font-size: 0.875rem;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }
    
    .form-select:hover, .form-input:hover {
        border-color: #cbd5e1;
    }
    
    .form-select:focus, .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-input {
        width: 120px;
        text-align: right;
    }
    
    @media (max-width: 640px) {
        .setting-content {
            flex-direction: column;
            gap: 1rem;
        }
        
        .setting-info {
            width: 100%;
        }
        
        .form-select, .form-input {
            width: 100%;
            text-align: left;
        }
        
        .toggle-container {
            align-self: flex-start;
        }
    }

    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 1rem 2rem;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
        pointer-events: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .toast.success {
        background-color: #10b981;
    }
    
    .toast.error {
        background-color: #ef4444;
    }
</style>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Theme switching function
    function setTheme(isDark) {
        const theme = isDark ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    }

    // Initialize theme
    const currentTheme = '{{ user_settings.theme }}';
    setTheme(currentTheme === 'dark');

    // Function to update a setting
    async function updateSetting(key, value) {
        try {
            const response = await fetch('{{ url_for("user.settings") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ [key]: value })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to update setting');
            }
            
            const result = await response.json();
            console.log(`Successfully updated ${key}:`, result);
            
            // If theme was updated, apply it immediately
            if (key === 'theme') {
                setTheme(value === 'dark');
            }
            
            // If we got back a group update, update all related fields
            if (result.group) {
                const groupPrefix = key.split('.')[0];
                Object.entries(result.group).forEach(([settingKey, settingValue]) => {
                    const fullKey = `${groupPrefix}.${settingKey}`;
                    const element = document.querySelector(`[name="${fullKey}"]`);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = settingValue;
                        } else {
                            element.value = settingValue;
                        }
                    }
                });
            }
            
            // Show success message
            showToast('Setting updated successfully', 'success');
            
        } catch (error) {
            console.error('Failed to update setting:', error);
            showToast(error.message || 'Failed to update setting', 'error');
        }
    }
    
    // Add event listeners to all form elements
    document.querySelectorAll('input, select').forEach(element => {
        if (element.type === 'checkbox') {
            element.addEventListener('change', (e) => {
                let value = e.target.checked;
                // Special handling for theme toggle
                if (e.target.name === 'theme') {
                    value = e.target.checked ? 'dark' : 'light';
                }
                updateSetting(e.target.name, value);
            });
        } else {
            element.addEventListener('change', (e) => {
                let value = e.target.value;
                if (element.type === 'number') {
                    value = parseInt(value, 10);
                }
                updateSetting(e.target.name, value);
            });
        }
    });

    // Toast notification function
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // Trigger reflow to ensure animation plays
        toast.offsetHeight;
        
        // Add animation
        toast.style.animation = 'slideIn 0.3s ease-out forwards';
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease-out forwards';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
});

// Add styles for toast notifications and animations
const style = document.createElement('style');
style.textContent = `
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 1rem 2rem;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        transform: translateX(120%);
    }
    
    .toast.success {
        background-color: #10b981;
    }
    
    .toast.error {
        background-color: #ef4444;
    }
    
    @keyframes slideIn {
        from { transform: translateX(120%); }
        to { transform: translateX(0); }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); }
        to { transform: translateX(120%); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %} 