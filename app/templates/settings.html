{% extends "base.html" %}

{% block title %}Beacon | Settings{% endblock %}

{% block content %}
<div class="main-content">
    <div class="settings-container">
        <h1 class="settings-title">Settings</h1>
        
        <div class="settings-section">
            <h2 class="section-title">General Settings</h2>
            <div class="setting-group">
                <div class="setting-item">
                    <div class="setting-content">
                        <div class="setting-info">
                            <span class="setting-title">Dark Theme</span>
                            <span class="setting-description">Switch between light and dark mode</span>
                        </div>
                        <div class="toggle-container">
                            <input type="checkbox" 
                                   name="theme" 
                                   id="theme"
                                   {% if user_settings.theme == 'dark' %}checked{% endif %}
                            >
                            <span class="toggle-switch"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <h2 class="section-title">Email Processing</h2>
            
            <div class="setting-group">
                <h3 class="group-title">Email Preferences</h3>
                <div class="setting-item">
                    <div class="setting-content">
                        <div class="setting-info">
                            <span class="setting-title">Email History</span>
                            <span class="setting-description">Number of days of email history to fetch</span>
                        </div>
                        <div class="button-group">
                            <button type="button" 
                                    class="value-button {% if user_settings.email_preferences.days_to_analyze == 1 %}selected{% endif %}"
                                    data-value="1" 
                                    data-setting="email_preferences.days_to_analyze">1d</button>
                            <button type="button" 
                                    class="value-button {% if user_settings.email_preferences.days_to_analyze == 3 %}selected{% endif %}"
                                    data-value="3" 
                                    data-setting="email_preferences.days_to_analyze">3d</button>
                            <button type="button" 
                                    class="value-button {% if user_settings.email_preferences.days_to_analyze == 5 %}selected{% endif %}"
                                    data-value="5" 
                                    data-setting="email_preferences.days_to_analyze">5d</button>
                            <button type="button" 
                                    class="value-button {% if user_settings.email_preferences.days_to_analyze == 7 %}selected{% endif %}"
                                    data-value="7" 
                                    data-setting="email_preferences.days_to_analyze">7d</button>
                            <button type="button" 
                                    class="value-button {% if user_settings.email_preferences.days_to_analyze == 14 %}selected{% endif %}"
                                    data-value="14" 
                                    data-setting="email_preferences.days_to_analyze">14d</button>
                        </div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-content">
                        <div class="setting-info">
                            <span class="setting-title">Cache Duration</span>
                            <span class="setting-description">Number of days to store emails in cache</span>
                        </div>
                        <div class="button-group">
                            <button type="button" 
                                    class="value-button {% if user_settings.email_preferences.cache_duration_days == 1 %}selected{% endif %}"
                                    data-value="1" 
                                    data-setting="email_preferences.cache_duration_days">1d</button>
                            <button type="button" 
                                    class="value-button {% if user_settings.email_preferences.cache_duration_days == 3 %}selected{% endif %}"
                                    data-value="3" 
                                    data-setting="email_preferences.cache_duration_days">3d</button>
                            <button type="button" 
                                    class="value-button {% if user_settings.email_preferences.cache_duration_days == 7 %}selected{% endif %}"
                                    data-value="7" 
                                    data-setting="email_preferences.cache_duration_days">7d</button>
                            <button type="button" 
                                    class="value-button {% if user_settings.email_preferences.cache_duration_days == 14 %}selected{% endif %}"
                                    data-value="14" 
                                    data-setting="email_preferences.cache_duration_days">14d</button>
                            <button type="button" 
                                    class="value-button {% if user_settings.email_preferences.cache_duration_days == 30 %}selected{% endif %}"
                                    data-value="30" 
                                    data-setting="email_preferences.cache_duration_days">30d</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="setting-group">
                <h3 class="group-title">AI Features</h3>
                <div class="setting-item">
                    <div class="setting-content">
                        <div class="setting-info">
                            <span class="setting-title">Enable AI Analysis</span>
                            <span class="setting-description">Turn on/off AI-powered email analysis</span>
                        </div>
                        <div class="toggle-container">
                            <input type="checkbox" 
                                   name="ai_features.enabled" 
                                   id="ai_features_enabled"
                                   {% if user_settings.get('ai_features', {}).get('enabled', True) %}checked{% endif %}
                            >
                            <span class="toggle-switch"></span>
                        </div>
                    </div>
                </div>

                <div class="ai-dependent-settings" {% if not user_settings.get('ai_features', {}).get('enabled', True) %}style="display: none;"{% endif %}>
                    <!-- LLM Configuration -->
                    <div class="setting-item">
                        <div class="setting-content">
                            <div class="setting-info">
                                <span class="setting-title">Model Selection</span>
                                <span class="setting-description">Choose between speed and accuracy (affects cost)</span>
                            </div>
                            <select id="model_type" name="ai_features.model_type" class="form-select">
                                <option value="gpt-4o-mini" {% if user_settings.get('ai_features', {}).get('model_type') == 'gpt-4o-mini' %}selected{% endif %}>Standard (GPT-4-mini)</option>
                                <option value="gpt-4" {% if user_settings.get('ai_features', {}).get('model_type') == 'gpt-4' %}selected{% endif %}>Premium (GPT-4)</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-content">
                            <div class="setting-info">
                                <span class="setting-title">Email Context Length</span>
                                <span class="setting-description">How much of each email to analyze (affects cost)</span>
                            </div>
                            <div class="button-group">
                                <button type="button" 
                                        class="value-button {% if user_settings.get('ai_features', {}).get('context_length') == '500' %}selected{% endif %}"
                                        data-value="500" 
                                        data-setting="ai_features.context_length">Short</button>
                                <button type="button" 
                                        class="value-button {% if user_settings.get('ai_features', {}).get('context_length') == '1000' %}selected{% endif %}"
                                        data-value="1000" 
                                        data-setting="ai_features.context_length">Medium</button>
                                <button type="button" 
                                        class="value-button {% if user_settings.get('ai_features', {}).get('context_length') == '2000' %}selected{% endif %}"
                                        data-value="2000" 
                                        data-setting="ai_features.context_length">Full</button>
                            </div>
                        </div>
                    </div>

                    <!-- Priority Settings -->
                    <div class="setting-item">
                        <div class="setting-content">
                            <div class="setting-info">
                                <span class="setting-title">Priority Threshold</span>
                                <span class="setting-description">Minimum priority level for important emails</span>
                            </div>
                            <div class="button-group">
                                <button type="button" 
                                        class="value-button {% if user_settings.get('ai_features', {}).get('priority_threshold') == 30 %}selected{% endif %}"
                                        data-value="30" 
                                        data-setting="ai_features.priority_threshold">Low</button>
                                <button type="button" 
                                        class="value-button {% if user_settings.get('ai_features', {}).get('priority_threshold') == 50 %}selected{% endif %}"
                                        data-value="50" 
                                        data-setting="ai_features.priority_threshold">Medium</button>
                                <button type="button" 
                                        class="value-button {% if user_settings.get('ai_features', {}).get('priority_threshold') == 70 %}selected{% endif %}"
                                        data-value="70" 
                                        data-setting="ai_features.priority_threshold">High</button>
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-content">
                            <div class="setting-info">
                                <span class="setting-title">Summary Length</span>
                                <span class="setting-description">Length of generated email summaries</span>
                            </div>
                            <div class="button-group">
                                <button type="button" 
                                        class="value-button {% if user_settings.get('ai_features', {}).get('summary_length') == 'short' %}selected{% endif %}"
                                        data-value="short" 
                                        data-setting="ai_features.summary_length">Short</button>
                                <button type="button" 
                                        class="value-button {% if user_settings.get('ai_features', {}).get('summary_length') == 'medium' %}selected{% endif %}"
                                        data-value="medium" 
                                        data-setting="ai_features.summary_length">Medium</button>
                                <button type="button" 
                                        class="value-button {% if user_settings.get('ai_features', {}).get('summary_length') == 'long' %}selected{% endif %}"
                                        data-value="long" 
                                        data-setting="ai_features.summary_length">Long</button>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Categories -->
                    <div class="setting-item custom-categories-section">
                        <div class="setting-content">
                            <div class="setting-info">
                                <span class="setting-title">Custom Categories</span>
                                <span class="setting-description">Add up to 3 custom categories for email classification</span>
                            </div>
                        </div>
                        
                        <div class="custom-categories-list">
                            {% set categories = user_settings.get('ai_features', {}).get('custom_categories', []) %}
                            {% for category in categories %}
                            <div class="custom-category-item">
                                <div class="category-header">
                                    <input type="text" 
                                           name="ai_features.custom_categories[{{ loop.index0 }}].name" 
                                           value="{{ category.get('name', '') }}"
                                           placeholder="e.g., Project Status"
                                           class="form-input category-name">
                                    <button type="button" class="delete-category-btn" title="Delete category">×</button>
                                </div>
                                <textarea name="ai_features.custom_categories[{{ loop.index0 }}].description" 
                                          placeholder="e.g., Track the current state of project-related emails"
                                          class="form-textarea category-description"
                                          maxlength="100">{{ category.get('description', '') }}</textarea>
                                <div class="category-values">
                                    <input type="text" 
                                           name="ai_features.custom_categories[{{ loop.index0 }}].values" 
                                           value="{{ category.get('values', [])|join(', ') }}"
                                           placeholder="e.g., Active, On Hold, Completed"
                                           class="form-input category-values-input">
                                </div>
                            </div>
                            {% endfor %}
                            {% if categories|length < 3 %}
                            <button type="button" id="add-category-btn" class="btn-secondary">
                                <span class="btn-icon">+</span>
                                Add Category ({{ 3 - categories|length }} remaining)
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    body {
        min-height: 100vh;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
    }

    :root {
        /* Light theme variables */
        --bg-color: #f5f7fa;
        --text-color: #2c3e50;
        --card-bg: #ffffff;
        --card-shadow: 0 2px 8px rgba(0,0,0,0.05);
        --input-bg: #ffffff;
        --input-border: #e2e8f0;
        --input-text: #2c3e50;
        --setting-item-bg: #f8f9fa;
        --setting-item-hover: #f0f2f5;
        --toggle-bg: #e2e8f0;
        --toggle-active: #3b82f6;
        --description-color: #6c757d;
    }

    [data-theme="dark"] {
        --bg-color: #1a1a1a;
        --text-color: #e2e8f0;
        --card-bg: #2d2d2d;
        --card-shadow: 0 2px 8px rgba(0,0,0,0.2);
        --input-bg: #3d3d3d;
        --input-border: #4a4a4a;
        --input-text: #e2e8f0;
        --setting-item-bg: #363636;
        --setting-item-hover: #404040;
        --toggle-bg: #4a4a4a;
        --toggle-active: #3b82f6;
        --description-color: #a0aec0;
    }

    .main-content {
        flex: 1;
        overflow-y: auto;
        padding: 10px 0;
        height: calc(100vh - 60px); /* Subtract header height */
    }
    
    .settings-container {
        max-width: 800px;
        margin: 0 auto;
        margin-bottom: 100px;
        padding: 0 1rem;
    }
    
    .settings-title {
        font-size: 2rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 2rem;
    }
    
    .settings-section {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 2rem;
        margin: 1.5rem 0;
        box-shadow: var(--card-shadow);
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 1.5rem;
    }
    
    .group-title {
        font-size: 1.2rem;
        font-weight: 500;
        color: var(--text-color);
        margin: 1.5rem 0 1rem;
    }
    
    .setting-group {
        margin-bottom: 2rem;
    }
    
    .setting-item {
        padding: 1rem;
        border-radius: 8px;
        background: var(--setting-item-bg);
        margin-bottom: 1rem;
        transition: background-color 0.2s ease;
    }
    
    .setting-item:hover {
        background: var(--setting-item-hover);
    }
    
    .setting-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;
    }
    
    .setting-info {
        flex: 1;
    }
    
    .setting-title {
        display: block;
        font-weight: 500;
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }
    
    .setting-description {
        display: block;
        font-size: 0.875rem;
        color: var(--description-color);
    }
    
    .toggle-container {
        position: relative;
        width: 50px;
        height: 26px;
        flex-shrink: 0;
        cursor: pointer;
    }
    
    .toggle-container input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        z-index: 3;
        margin: 0;
        padding: 0;
        top: 0;
        left: 0;
        cursor: pointer;
    }
    
    .toggle-switch {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--toggle-bg);
        transition: .4s;
        border-radius: 34px;
        pointer-events: none;
    }
    
    .toggle-switch:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        pointer-events: none;
    }
    
    input:checked + .toggle-switch {
        background-color: var(--toggle-active);
    }
    
    input:checked + .toggle-switch:before {
        transform: translateX(24px);
    }
    
    .form-select, .form-input {
        padding: 0.5rem 1rem;
        border: 1px solid var(--input-border);
        border-radius: 6px;
        min-width: 120px;
        background-color: var(--input-bg);
        color: var(--input-text);
        font-size: 0.875rem;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }
    
    .form-select:hover, .form-input:hover {
        border-color: #cbd5e1;
    }
    
    .form-select:focus, .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-input {
        width: 120px;
        text-align: right;
    }
    
    @media (max-width: 640px) {
        .setting-content {
            flex-direction: column;
            gap: 1rem;
        }
        
        .setting-info {
            width: 100%;
        }
        
        .form-select, .form-input {
            width: 100%;
            text-align: left;
        }
        
        .toggle-container {
            align-self: flex-start;
        }
    }

    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 1rem 2rem;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
        pointer-events: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .toast.success {
        background-color: #10b981;
    }
    
    .toast.error {
        background-color: #ef4444;
    }

    .ai-dependent-settings {
        margin-top: 1rem;
        padding-left: 1rem;
        border-left: 2px solid var(--input-border);
    }

    .slider-container,
    .slider-input,
    .slider-input::-webkit-slider-thumb,
    .slider-input::-moz-range-thumb,
    .slider-value {
        display: none;
    }

    .button-group {
        display: flex;
        gap: 0.5rem;
    }

    .value-button {
        padding: 0.5rem 1rem;
        border: 1px solid var(--input-border);
        border-radius: 6px;
        background: var(--input-bg);
        color: var(--text-color);
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .value-button:hover {
        border-color: var(--toggle-active);
    }

    .value-button.selected {
        background: var(--toggle-active);
        color: white;
        border-color: var(--toggle-active);
    }

    .custom-categories-section {
        margin-top: 1rem;
    }

    .custom-categories-list {
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: 100%;
        box-sizing: border-box;
    }

    .custom-category-item {
        background: var(--setting-item-bg);
        border-radius: 8px;
        padding: 1.25rem;
        border: 1px solid var(--input-border);
        box-sizing: border-box;
    }

    .category-header {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.75rem;
        width: 100%;
        box-sizing: border-box;
    }

    .category-name {
        flex: 1;
        width: 100%;
        text-align: left;
        font-weight: 500;
        padding: 0.5rem 0.75rem;
        box-sizing: border-box;
    }

    .category-description {
        display: block;
        width: 100%;
        min-height: 60px;
        max-height: 120px;
        padding: 0.75rem;
        margin: 0.5rem 0;
        border: 1px solid var(--input-border);
        border-radius: 6px;
        background: var(--input-bg);
        color: var(--input-text);
        font-size: 0.875rem;
        resize: vertical;
        line-height: 1.5;
        box-sizing: border-box;
    }

    .category-values {
        margin-top: 0.75rem;
        width: 100%;
        box-sizing: border-box;
    }

    .category-values-input {
        display: block;
        width: 100%;
        text-align: left;
        padding: 0.5rem 0.75rem;
        box-sizing: border-box;
    }

    /* Override any default form styles */
    .custom-category-item input,
    .custom-category-item textarea {
        margin: 0;
        max-width: 100%;
    }

    .form-input::placeholder,
    .form-textarea::placeholder {
        color: var(--description-color);
        opacity: 0.7;
    }

    .form-input:focus::placeholder,
    .form-textarea:focus::placeholder {
        opacity: 0.5;
    }

    /* Add subtle hover effect */
    .custom-category-item:hover {
        border-color: var(--toggle-active);
    }

    /* Focus styles */
    .custom-category-item .form-input:focus,
    .custom-category-item .form-textarea:focus {
        border-color: var(--toggle-active);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        outline: none;
    }

    .delete-category-btn {
        background: none;
        border: none;
        color: var(--description-color);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0 0.5rem;
        transition: color 0.2s;
    }

    .delete-category-btn:hover {
        color: #ef4444;
    }

    #add-category-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.75rem;
        background: var(--setting-item-bg);
        border: 2px dashed var(--input-border);
        color: var(--description-color);
        font-weight: 500;
        transition: all 0.2s;
    }

    #add-category-btn:hover {
        border-color: var(--toggle-active);
        color: var(--toggle-active);
    }

    .btn-icon {
        font-size: 1.25rem;
        line-height: 1;
    }
</style>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers for value buttons
    document.querySelectorAll('.value-button').forEach(button => {
        button.addEventListener('click', async (e) => {
            const value = e.target.dataset.value;
            const setting = e.target.dataset.setting;
            
            // Update visual state
            e.target.closest('.button-group').querySelectorAll('.value-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            e.target.classList.add('selected');
            
            // Update setting
            try {
                // Convert to number only for specific settings that need it
                const numericSettings = ['email_preferences.days_to_analyze', 'email_preferences.cache_duration_days', 'ai_features.priority_threshold'];
                const finalValue = numericSettings.includes(setting) ? parseInt(value, 10) : value;
                await updateSetting(setting, finalValue);
            } catch (error) {
                console.error('Failed to update setting:', error);
                // Revert visual state on error
                e.target.classList.remove('selected');
            }
        });
    });

    // Theme switching function
    function setTheme(isDark) {
        const theme = isDark ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    }

    // Initialize theme
    const currentTheme = '{{ user_settings.theme }}';
    setTheme(currentTheme === 'dark');

    // Function to update a setting
    async function updateSetting(key, value) {
        try {
            const response = await fetch('{{ url_for("user.settings") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ [key]: value })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to update setting');
            }
            
            const result = await response.json();
            console.log(`Successfully updated ${key}:`, result);
            
            // If theme was updated, apply it immediately
            if (key === 'theme') {
                setTheme(value === 'dark');
            }
            
            // If we got back a group update, update all related fields
            if (result.group) {
                const groupPrefix = key.split('.')[0];
                Object.entries(result.group).forEach(([settingKey, settingValue]) => {
                    const fullKey = `${groupPrefix}.${settingKey}`;
                    const element = document.querySelector(`[name="${fullKey}"]`);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = settingValue;
                        } else {
                            element.value = settingValue;
                        }
                    }
                });
            }
            
            // Show success message
            showToast('Setting updated successfully', 'success');
            
        } catch (error) {
            console.error('Failed to update setting:', error);
            showToast(error.message || 'Failed to update setting', 'error');
        }
    }
    
    // Add event listeners to all form elements
    document.querySelectorAll('input, select').forEach(element => {
        if (element.type === 'checkbox') {
            element.addEventListener('change', (e) => {
                let value = e.target.checked;
                // Special handling for theme toggle
                if (e.target.name === 'theme') {
                    value = e.target.checked ? 'dark' : 'light';
                }
                updateSetting(e.target.name, value);
            });
        } else {
            element.addEventListener('change', (e) => {
                let value = e.target.value;
                if (element.type === 'number') {
                    value = parseInt(value, 10);
                }
                updateSetting(e.target.name, value);
            });
        }
    });

    // Toast notification function
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // Trigger reflow to ensure animation plays
        toast.offsetHeight;
        
        // Add animation
        toast.style.animation = 'slideIn 0.3s ease-out forwards';
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease-out forwards';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // AI Features Toggle
    const aiToggle = document.getElementById('ai_features_enabled');
    const aiDependentSettings = document.querySelector('.ai-dependent-settings');
    const customCategoriesList = document.getElementById('custom-categories-list');

    if (aiToggle && aiDependentSettings) {
        aiToggle.addEventListener('change', function() {
            aiDependentSettings.style.display = this.checked ? 'block' : 'none';
            if (!this.checked) {
                customCategoriesList.style.display = 'none';
            } else {
                // Check if custom categories are enabled
                const customCategoriesEnabled = document.getElementById('custom_categories_enabled');
                if (customCategoriesEnabled && customCategoriesEnabled.checked) {
                    customCategoriesList.style.display = 'block';
                }
            }
        });
    }

    // Custom Categories Management
    const addCategoryBtn = document.getElementById('add-category-btn');
    const categoriesList = document.querySelector('.custom-categories-list');
    
    if (addCategoryBtn) {
        addCategoryBtn.addEventListener('click', function() {
            const categoryItems = document.querySelectorAll('.custom-category-item');
            if (categoryItems.length >= 3) {
                showToast('Maximum of 3 categories allowed', 'error');
                return;
            }
            
            const newCategory = document.createElement('div');
            newCategory.className = 'custom-category-item';
            newCategory.innerHTML = `
                <div class="category-header">
                    <input type="text" 
                           name="ai_features.custom_categories[${categoryItems.length}].name" 
                           placeholder="e.g., Project Status"
                           class="form-input category-name">
                    <button type="button" class="delete-category-btn" title="Delete category">×</button>
                </div>
                <textarea name="ai_features.custom_categories[${categoryItems.length}].description" 
                          placeholder="e.g., Track the current state of project-related emails"
                          class="form-textarea category-description"
                          maxlength="100"></textarea>
                <div class="category-values">
                    <input type="text" 
                           name="ai_features.custom_categories[${categoryItems.length}].values" 
                           placeholder="e.g., Active, On Hold, Completed"
                           class="form-input category-values-input">
                </div>
            `;
            
            // Insert before the add button
            categoriesList.insertBefore(newCategory, addCategoryBtn);
            
            // Update remaining count
            const remaining = 3 - document.querySelectorAll('.custom-category-item').length;
            addCategoryBtn.innerHTML = `
                <span class="btn-icon">+</span>
                Add Category (${remaining} remaining)
            `;
            
            // Hide button if max reached
            if (remaining === 0) {
                addCategoryBtn.style.display = 'none';
            }
            
            // Focus the new category name input
            newCategory.querySelector('.category-name').focus();
        });
    }
    
    // Delete Category
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-category-btn')) {
            const categoryItem = e.target.closest('.custom-category-item');
            if (categoryItem) {
                categoryItem.remove();
                
                // Reindex remaining categories
                document.querySelectorAll('.custom-category-item').forEach((item, index) => {
                    item.querySelectorAll('[name*="custom_categories["]').forEach(input => {
                        input.name = input.name.replace(/custom_categories\[\d+\]/, `custom_categories[${index}]`);
                    });
                });
                
                // Update add button visibility and count
                const addBtn = document.getElementById('add-category-btn');
                if (addBtn) {
                    const remaining = 3 - document.querySelectorAll('.custom-category-item').length;
                    addBtn.style.display = 'flex';
                    addBtn.innerHTML = `
                        <span class="btn-icon">+</span>
                        Add Category (${remaining} remaining)
                    `;
                }
                
                // Update the settings using the debounced function
                debouncedUpdateCategories();
            }
        }
    });
    
    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Debounced version of updateCustomCategories
    const debouncedUpdateCategories = debounce(async function() {
        const categories = [];
        document.querySelectorAll('.custom-category-item').forEach(item => {
            categories.push({
                name: item.querySelector('.category-name').value,
                description: item.querySelector('.category-description').value,
                values: item.querySelector('.category-values-input').value
                    .split(',')
                    .map(v => v.trim())
                    .filter(v => v)
            });
        });
        
        try {
            await updateSetting('ai_features.custom_categories', categories);
        } catch (error) {
            console.error('Failed to update custom categories:', error);
            showToast('Failed to update categories', 'error');
        }
    }, 1000); // Wait 1 second after last input before updating
    
    // Update custom categories when inputs change (now debounced)
    document.addEventListener('input', function(e) {
        if (e.target.closest('.custom-category-item')) {
            debouncedUpdateCategories();
        }
    });
});

// Add styles for toast notifications and animations
const style = document.createElement('style');
style.textContent = `
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 1rem 2rem;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        transform: translateX(120%);
    }
    
    .toast.success {
        background-color: #10b981;
    }
    
    .toast.error {
        background-color: #ef4444;
    }
    
    @keyframes slideIn {
        from { transform: translateX(120%); }
        to { transform: translateX(0); }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); }
        to { transform: translateX(120%); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %} 